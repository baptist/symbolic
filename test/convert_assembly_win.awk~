#!/usr/bin/gawk -f
BEGIN {
	FS = "[\t,]+";
	infunction = 0
}

$0 ~ /[a-zA-z0-9]+[\t ]PROC/ {
	if ($1 == "sub") {
		infunction = 1
		print "void sub(double* Y, double* X) { \n"
	} else if ($1 == "init_sub") {
		infunction = 1;
		print "void init_sub() {"
	}
}

#
$0 ~ /mov|push|add|sub|pop|leave/ && infunction == 1 && $0 !~ /[a-zA-z0-9]+[\t ]PROC/ {
	if (NF > 3) {
		printf( "avx_%s(", trim($2))	
		for (i=3; i <= NF; i++) {
			if (trim($i) != "") {
				printf( "%s", trim($i))
				if (i < NF) {
					printf(",")
				}
			}
		}
		printf( "); ")
	}
	else
	{
		print "avx_" $2 "();"
	}

}

/ret/ {
	print "}"
	infunction = 0
}

END {
	
}


function ltrim(s) { gsub(/^[ \t]+/, "", s); return s }
function rtrim(s) { gsub(/[ \t]+$/, "", s); return s }
function trim(s)  { return rtrim(ltrim(s)); }

